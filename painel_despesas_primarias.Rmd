---
title: "Painel de despesas primárias"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
resource_files:
- rtn_despesas.rds
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(ggplot2)
library(forcats)
library(colorspace)
library(ckanr)
library(readxl)
library(tidyr)
library(plotly)
library(stringr)
library(scales)


selecionaValor <- function(tipo_valor_historico){
  
  if (tipo_valor_historico){
    var_valor<- "total_paga_ano"
  } else{
    var_valor<- "total_paga_ano_deflacionado"
  }

  var_valor
}

rankingTotal<- function(.data,by,n=10){
  

  .data %>%
    inner_join(
      .data %>%
        group_by(!!sym(by)) %>%
        summarise(
          total= sum(total_paga_ano)
        ) %>%   
        slice_max(order_by = total, n=n) %>%
        distinct(!!sym(by))   
    )   
}


trazDadosAtualizados<- function(){
  
  #Traz o rtn_dimensional_ipca atual
  rtn_dimensional_ipca <- readRDS("rtn_dimensional_ipca.rds")

  
  #Traz todos os datasets que tratam de despesas primárias
  datasets<- ckanr::resource_search(url = "https://www.tesourotransparente.gov.br/ckan",
                                    id="8675a0a4-31c5-4593-a24d-fb8e17376eca",
                                    q= "name:Despesas e Transferências Totais da União")
  
  #O primeiro dataset é sempre o do último ano
  
  #Checa se é necessário atualizar o modelo dimensional
  data_ultima_atualizacao<-url_despesa_ult_mes<-datasets[["results"]][[1]][["last_modified"]]
  
  lubridate::as_date(data_ultima_atualizacao)
  
  
  load("data_ultimo_rds.RData")
  
  
  #Se a data for superior ao último processamento atualiza o modelo dimensional
  if (lubridate::as_date(data_ultima_atualizacao) > data_ultimo_rds){
    url_despesa_ult_mes<-datasets[["results"]][[1]][["url"]]
    
    download.file(url = url_despesa_ult_mes, destfile = "arquivo_despesa.xlsx", mode = "wb")
    
    sheets<- readxl::excel_sheets("arquivo_despesa.xlsx")
    
    if (length(sheets)==2){
      sheet_num<- 1
    } else{
      sheet_num <- 2
    }
    
    
    
    rtn_despesas_primarias_ult_ano<-
      readxl::read_xlsx("arquivo_despesa.xlsx", sheet = sheet_num)
    
    
    
    #Processa os dados de IPCA
    tb_ckan<-resource_show(id="527ccdb1-3059-42f3-bf23-b5e3ab4c6dc6",url="http://www.tesourotransparente.gov.br/ckan")
    
    
    URL_add <- tb_ckan$url
    
    tmp <- tempfile(fileext = ".xlsx")
    
    download.file(URL_add,mode = "wb", destfile = tmp, extra = "-R", method = "libcurl")
    
    names_deflator_IPCA <- read_xlsx(tmp,sheet = 3,skip = 4,n_max = 1, col_names = TRUE)
    deflator_IPCA <- read_xlsx(tmp,sheet = 3,skip = 74,n_max = 1, col_names = FALSE)
    
    names(deflator_IPCA) <- names(names_deflator_IPCA)
    
    names(deflator_IPCA)[1]<-"Rubrica"
    series_temporais_analise_IPCA<-gather(deflator_IPCA,Data, Valor,-Rubrica)
    #series_temporais_analise_IPCA$Data<-gsub("X","",series_temporais_analise_IPCA$Data)
    series_temporais_analise_IPCA$Data<-as.Date(as.numeric(series_temporais_analise_IPCA$Data), origin="1899-12-30")
    series_temporais_analise_IPCA$Valor <-as.numeric(series_temporais_analise_IPCA$Valor)
    
    
    
    
    ultimo_ano<- max(rtn_dimensional_ipca$ID_ANO)
    
    #Gera o novo rtn_dimensional_ipca 
    rtn_dimensional_ipca<-
      rtn_despesas_primarias_ult_ano %>%
      mutate(Data = as.Date(paste(ID_ANO, ID_MES,"01",sep="-")) ) %>%
      inner_join(series_temporais_analise_IPCA) %>%
      mutate(valor_deflacionado = DESPESAS_PAGAS * Valor) %>%
      group_by(ID_ANO, CATEGORIA_RTN,NO_FUNCAO_PT, ORGAO_DESCRICAO, NO_PROGRAMA_PT,NO_ACAO) %>%
      summarise(
        total_paga_ano = sum(DESPESAS_PAGAS),
        total_paga_ano_deflacionado = sum(valor_deflacionado)
      ) %>%
      ungroup() %>%
      bind_rows(
        rtn_dimensional_ipca %>%
          filter(ID_ANO!=ultimo_ano)
      )
    
    
    
    data_ultimo_rds<- lubridate::today()
    save(list = "data_ultimo_rds", file = "data_ultimo_rds.RData")
    
    
  }
  
  rtn_dimensional_ipca
}


rtn_despesas <- trazDadosAtualizados()# readRDS("rtn_dimensional_ipca.rds")

max_ano<- max(rtn_despesas$ID_ANO)


rtn_despesas<-
  rtn_despesas %>%
    mutate(CATEGORIA_RTN = stringr::str_replace_all(CATEGORIA_RTN,"II\\.","2\\.")) %>% 
    mutate(CATEGORIA_RTN = stringr::str_replace_all(CATEGORIA_RTN,"I\\.","1\\.")) %>% 
    mutate(CATEGORIA_RTN= stringr::str_squish ( stringr::str_remove_all(CATEGORIA_RTN,"[:punct:]|[0-9]|[:symbol:]")))


```

# Conta por função

## Inputs {.sidebar data-width="150"}

```{r}
selectInput(inputId = "conta", label= "Selecione uma conta", choices= unique(rtn_despesas$CATEGORIA_RTN),selected = "Pessoal e Encargos Sociais Ativo civil", multiple = TRUE )
sliderInput("numero_funcao","Informe o número de funções de maior despesa",1,30,10)
sliderInput("periodo", "Informe o período",2008, max_ano,c(2008,max_ano), sep="")
checkboxInput("valor_historico","Usar valor historico")
checkboxInput("freeScale","Usar escala livre")

```

## Column {data-width = 400}

### Evolução anual para todas funções de acordo com uma conta selecionada (valores em R\$mi)

```{r}

renderPlotly({
  
  var_valor<- selecionaValor(input$valor_historico)
  
  graph<-
    rtn_despesas %>%
    filter(CATEGORIA_RTN %in% c(input$conta),
           #ID_ANO<max(rtn_despesas$ID_ANO),
           ID_ANO>= input$periodo[1] & ID_ANO<= input$periodo[2]) %>%
    rankingTotal("NO_FUNCAO_PT",n=input$numero_funcao) %>%
    mutate( ano=trunc(ID_ANO),
            conta = CATEGORIA_RTN,
            NO_FUNCAO_PT = forcats::fct_reorder(NO_FUNCAO_PT,total_paga_ano,.fun = sum, .desc = TRUE)) %>%  
    group_by(ano,NO_FUNCAO_PT, conta) %>%
    summarise(
       despesa = round(sum(!!sym(var_valor))/10^6)
    ) %>%
    ungroup() %>%
    ggplot() +
    geom_line(aes(x=ano, y=despesa, color=str_wrap(conta,10), text= conta ))+
    scale_color_discrete_qualitative(palette = "Dark 3")+
    scale_x_continuous(breaks= pretty_breaks())+
    theme_light() +
    theme(
      axis.text.x = element_text(angle = 90),
      panel.background = element_rect(fill = "#15202B"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      legend.position = "right",
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white")
    )+
    labs(
      color = "conta"
    ) 
  
  if (input$freeScale){
    graph<-
      graph+ 
      facet_wrap(NO_FUNCAO_PT~., scales = "free_y", ncol = 4) +
      expand_limits(y=0)
    
  } else{
    graph<-
      graph+ facet_wrap(NO_FUNCAO_PT~.)
    
  }
  
  
  #graph
  
  ggplotly(graph, tooltip = c("ano", "despesa", "text"))
  
  
})

```

# Função por Conta

## Inputs {.sidebar data-width="150"}

```{r}
selectInput(inputId = "funcao", label= "Selecione uma função", choices= unique(rtn_despesas$NO_FUNCAO_PT),selected = "SAUDE", multiple = TRUE )
sliderInput("numero_conta_funcao","Informe o número de contas de maior despesa",1,30,10)
sliderInput("periodo_conta", "Informe o período",2008, max_ano,c(2008,max_ano), sep="")
checkboxInput("valor_historico_funcao","Usar valor historico")
checkboxInput("freeScale_funcao","Usar escala livre")
```

## Column {data-width = 400}

### Evolução anual para todas contas de acordo com uma função selecionada (valores em R\$mi)

```{r}

renderPlotly({
  
  
  var_valor<- selecionaValor(input$valor_historico_funcao)

  
  graph<-
    rtn_despesas %>%
    filter(NO_FUNCAO_PT %in% c(input$funcao),
           #ID_ANO<max(rtn_despesas$ID_ANO),
           ID_ANO>= input$periodo_conta[1] & ID_ANO<= input$periodo_conta[2]) %>%
    rankingTotal("CATEGORIA_RTN",n=input$numero_conta_funcao) %>%
    mutate(conta = forcats::fct_reorder(CATEGORIA_RTN,total_paga_ano,.fun = sum, .desc = TRUE),
           funcao = NO_FUNCAO_PT,
           ano = ID_ANO) %>%  
    group_by(ano,funcao, conta) %>%
    summarise(
      despesa = round(sum(!!sym(var_valor))/10^6)
    ) %>%
    ungroup() %>%
    ggplot() +
    geom_line(aes(x=ano, y=despesa, color=str_wrap(funcao,10), text = paste(conta, funcao, sep = "-")))+
    scale_color_discrete_qualitative(palette = "Dark 3")+
    scale_x_continuous(breaks= pretty_breaks())+
    theme_light() +
    theme(
      axis.text.x = element_text(angle = 90),
      panel.background = element_rect(fill = "#15202B"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      legend.position = "right",
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white",size = 8)
    )+
    labs(
      x="ano",
      y= "Despesa",
      color = "função"
    ) 
  
  if (input$freeScale_funcao){
    graph<-
      graph+ 
      theme(
        strip.text = element_text(color = "white",size = 7)
      ) +
      facet_wrap(conta~., scales = "free_y")+
      expand_limits(y=0)
    
  } else{
    graph<-
      graph+ facet_wrap(conta~.)
    
  }
  
  ggplotly(graph, tooltip = c("ano", "despesa", "text"))
  
})

```

# Orgão por Conta

## Inputs {.sidebar data-width="150"}

```{r}
selectInput(inputId = "orgao", label= "Selecione um órgão", choices= unique(rtn_despesas$ORGAO_DESCRICAO),selected = "MINISTERIO DA SAUDE", multiple = TRUE )
sliderInput("numero_conta_orgao","Informe o número de contas de maior despesa",1,30,10)
sliderInput("periodo_orgao", "Informe o período",2008, max_ano,c(2008,max_ano), sep="")
checkboxInput("valor_historico_orgao","Usar valor historico")
checkboxInput("freeScale_orgao","Usar escala livre")
```

## Column {data-width = 400}

### Evolução anual para todas contas de acordo com um órgão selecionado (valores em R$mi)

```{r}

renderPlotly({
  
  var_valor<- selecionaValor(input$valor_historico_orgao)
  
  graph<-
    rtn_despesas %>%
    filter(ORGAO_DESCRICAO %in% c(input$orgao),
           #ID_ANO<max(rtn_despesas$ID_ANO),
           ID_ANO>= input$periodo_orgao[1] & ID_ANO<= input$periodo_orgao[2]) %>%
    rankingTotal("CATEGORIA_RTN",n=input$numero_conta_orgao) %>%
    mutate(conta = forcats::fct_reorder(CATEGORIA_RTN,total_paga_ano,.fun = sum, .desc = TRUE),
           orgao = ORGAO_DESCRICAO,
           ano = ID_ANO) %>%  
    group_by(ano,orgao, conta) %>%
    summarise(
      despesa = round(sum(!!sym(var_valor))/10^6)
    ) %>%
    ungroup() %>%
    ggplot() +
    geom_line(aes(x=ano, y=despesa, color= str_wrap(orgao,10), text= paste(conta, orgao, sep = "-" )))+
    scale_color_discrete_qualitative(palette = "Dark 3")+
    scale_x_continuous(breaks= pretty_breaks())+
    theme_light() +
    theme(
      axis.text.x = element_text(angle = 90),
      panel.background = element_rect(fill = "#15202B"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      legend.position = "right",
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white",size = 8)
    )+
    labs(
      x="ano",
      y= "Despesa",
      color = "conta"
    ) 
  
  if (input$freeScale_orgao){
    graph<-
      graph+ 
      theme(
        strip.text = element_text(color = "white",size = 7)
      ) +
      facet_wrap(conta~., scales = "free_y")+
      expand_limits(y=0)
    
  } else{
    graph<-
      graph+ facet_wrap(conta~.)
    
  }
  
  ggplotly(graph, tooltip = c("ano", "despesa",  "text"))
  
  
})

```

# Programa de trabalho por Conta

## Inputs {.sidebar data-width="150"}

```{r}
selectInput(inputId = "pt", label= "Selecione um programa de trabalho", choices= unique(rtn_despesas$NO_PROGRAMA_PT),selected = "GESTAO DA POLITICA DE SAUDE", multiple = TRUE )
sliderInput("numero_conta_pt","Informe o número de contas de maior despesa",1,30,10)
sliderInput("periodo_pt", "Informe o período",2008, max_ano,c(2008,max_ano), sep="")
checkboxInput("valor_historico_pt","Usar valor historico")
checkboxInput("freeScale_pt","Usar escala livre")
```

## Column {data-width = 400}

### Evolução anual para todas contas de acordo com um programa de trabalho selecionado (valores em R$mi)

```{r}

renderPlotly({
  
  var_valor<- selecionaValor(input$valor_historico_pt)
  
  graph<-
    rtn_despesas %>%
    filter(NO_PROGRAMA_PT %in% c(input$pt),
           #ID_ANO<max(rtn_despesas$ID_ANO),
           ID_ANO>= input$periodo_pt[1] & ID_ANO<= input$periodo_pt[2]) %>%
    rankingTotal("CATEGORIA_RTN",n=input$numero_conta_pt) %>%
    mutate(conta = forcats::fct_reorder(CATEGORIA_RTN,total_paga_ano,.fun = sum, .desc = TRUE),
           ano = ID_ANO,
           programa = NO_PROGRAMA_PT) %>%  
    group_by(ano,programa, conta) %>%
    summarise(
      despesa = round(sum(!!sym(var_valor))/10^6)
    ) %>%
    ungroup() %>%
    ggplot() +
    geom_line(aes(x=ano, y=despesa, color=str_wrap(programa,10), text= paste(conta, programa, sep = "-")))+
    scale_color_discrete_qualitative(palette = "Dark 3")+
    scale_x_continuous(breaks= pretty_breaks())+
    theme_light() +
    theme(
      axis.text.x = element_text(angle = 90),
      panel.background = element_rect(fill = "#15202B"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      legend.position = "bottom",
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white")
    )+
    labs(
      color = "conta"
    ) 
  

  if (input$freeScale_pt){
    graph<-
      graph+ 
      theme(
        strip.text = element_text(color = "white",size = 7)
      ) +
      facet_wrap(conta~., scales = "free_y")+
      expand_limits(y=0)
    
  } else{
    graph<-
      graph+ facet_wrap(conta~.)
    
  }
  
  ggplotly(graph, tooltip = c("ano", "despesa",  "text"))
  
  
})

```

# Ação orçamentária por Conta

## Inputs {.sidebar data-width="150"}

```{r}
selectInput(inputId = "acao", label= "Selecione uma ação orçamentária", choices= unique(rtn_despesas$NO_ACAO),selected = "ESTRUTURACAO DE UNIDADES DE ATENCAO ESPECIALIZADA EM SAUDE", multiple = TRUE )
sliderInput("numero_conta_acao","Informe o número de contas de maior despesa",1,30,10)
sliderInput("periodo_acao", "Informe o período",2008, max_ano,c(2008,max_ano), sep="")
checkboxInput("valor_historico_acao","Usar valor historico")
checkboxInput("freeScale_acao","Usar escala livre")
```

## Column {data-width = 400}

### Evolução anual para todas contas de acordo com um programa de trabalho selecionado (valores em R\$mi)

```{r}

renderPlotly({
  
  var_valor<- selecionaValor(input$valor_historico_acao)
  
  graph<-
    rtn_despesas %>%
    filter(NO_ACAO %in% c(input$acao),
           #ID_ANO<max(rtn_despesas$ID_ANO),
           ID_ANO>= input$periodo_acao[1] & ID_ANO<= input$periodo_acao[2]) %>%
    mutate(CATEGORIA_RTN = forcats::fct_reorder(CATEGORIA_RTN,total_paga_ano,.fun = sum, .desc = TRUE)) %>%  
    rankingTotal("CATEGORIA_RTN",n=input$numero_conta_acao) %>%
    mutate(conta = forcats::fct_reorder(CATEGORIA_RTN,total_paga_ano,.fun = sum, .desc = TRUE),
           ano = ID_ANO,
           acao = NO_ACAO) %>%    
    group_by(ano, acao, conta) %>%
    summarise(
      despesa = round(sum(!!sym(var_valor))/10^6)
    ) %>%
    ungroup() %>%
    ggplot() +
    geom_line(aes(x=ano, y=despesa, color=str_wrap(acao,10), text = paste(conta, acao, sep="-")))+
    scale_color_discrete_qualitative(palette = "Dark 3")+
    scale_x_continuous(breaks= pretty_breaks())+
    theme_light() +
    theme(
      axis.text.x = element_text(angle = 90),
      panel.background = element_rect(fill = "#15202B"),
      panel.grid = element_blank(),
      axis.title.x = element_blank(),
      legend.position = "right",
      strip.background = element_rect(fill = "#505050"),
      strip.text = element_text(color = "white")
    )+
    labs(
      color = "conta"
    ) 
  
  if (input$freeScale_acao){
    graph<-
      graph+ 
      facet_wrap(conta~., scales = "free_y")+
      expand_limits(y=0)
    
  } else{
    graph<-
      graph+ facet_wrap(conta~.)
    
  }
  
  ggplotly(graph, tooltip = c("ano", "despesa",  "text"))
  
  
})

```
